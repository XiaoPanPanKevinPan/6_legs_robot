<!DOCTYPE html>
<html><head>
	<title>Robot Control</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<script type="module">
		import { createApp } from './node_modules/vue/dist/vue.esm-browser.js';

		window.hostIP = "";
		const
			servos = "1,2,3,4,5,6,7,8,9,16,17,25,19,20,21,22,23,24",
			initDeg = [98,50,120, 80,100,120, 100,102,121, 93,87,68, 95,123,61, 100,91,98],
			axesCorrection = [-1,-1,-1, -1,-1,-1, -1,-1,-1, 1,1,1, 1,1,1, 1,1,1,],
			// (front, back) = (+, -)
			// (up, down) = (+, -)
			// (far, near) = (+, -)

			none = [0, 0, 0], deg = 25,
			push = [0, -deg, deg], hang = [0, deg, deg],
			crowded = [0, deg, -deg], focused = [0, -deg, -deg], 
			waveForw = [deg, 0, 0], waveBack = [-deg, 0, 0],

			arrToStr = (arr) => arr.reduce((tmp, cur) => tmp + `,${cur}`),
			add = (orig, delt) => orig.map((val, index) => val + delt[index]),
			mul = (arr1, arr2) => arr1.map((val, index) => val * arr2[index]),

			degCor = deg => deg < 0 ? 1 : deg == 0 ? 0 : Math.asin((2 ** -0.5) * Math.sin(deg / 180 * Math.PI)) / Math.PI * 180 / deg,
			// middle 2 legs should have different degrees to the four legs at its head and end

			corr = (deg, arr) => mul(mul(arr, axesCorrection), [1,1,1, degCor(deg),1,1, 1,1,1, 1,1,1, degCor(deg),1,1, 1,1,1]),
			comp = (deg, ...arrs) => add(initDeg, corr(deg, arrs.reduce((tmp, cur) => tmp.concat(cur))))
				.map(i => Math.round(i))
				.map(i => 0 >= i ? 0 : 180 <= i ? 180 : i);

		const hf = add(hang, waveForw), hb = add(hang, waveBack), pf = add(push, waveForw), pb = add(push, waveBack); 

		let basicCtrls = [{
			name: "初始姿態",
			degs: arrToStr(initDeg),
			code: "INIT"
		}, {
			name: "ready",
			degs: comp(deg, push, push, push, push, push, push),
			code: "READY"
		}, {
			name: "A",
			degs: comp(deg, pb, hf, pb, hf, pb, hf),
			code: "A"
		}, {
			name: "B",
			degs: comp(deg, pb, pf, pb, pf, pb, pf),
			code: "B"
		}, {
			name: "C",
			degs: comp(deg, hf, pf, hf, pf, hf, pf),
			code: "C"
		}, {
			name: "D",
			degs: comp(deg, hf, pb, hf, pb, hf, pb),
			code: "D"
		}, {
			name: "E",
			degs: comp(deg, pf, pb, pf, pb, pf, pb),
			code: "E"
		}, {
			name: "F",
			degs: comp(deg, pf, hf, pf, hf, pf, hf),
			code: "F"
		}, {
			name: "hf",
			degs: comp(deg, hf, hf, hf, hf, hf, hf),
			code: "hf"
		}, {
			name: "pf",
			degs: comp(deg, pf, pf, pf, pf, pf, pf),
			code: "pf"
		}, {
			name: "hb",
			degs: comp(deg, hb, hb, hb, hb, hb, hb),
			code: "hb"
		}, {
			name: "pb",
			degs: comp(deg, pb, pb, pb, pb, pb, pb),
			code: "pb"
		}, {
			name: "N",
			degs: comp(-1, hang, push, hang, push, hang, push),
			code: "N"
		}, {
			name: "O",
			degs: comp(-1, hb, push, hb, push, hf, push),
			code: "O"
		}, {
			name: "P",
			degs: comp(-1, pb, push, pb, push, pf, push),
			code: "P"
		}, {
			name: "Q",
			degs: comp(-1, pb, hang, pb, hang, pb, hang),
			code: "Q"
		}, {
			name: "R",
			degs: comp(-1, push, hang, push, hang, push, hang),
			code: "R"
		}, {
			name: "hang",
			degs: comp(deg, hang, hang, hang, hang, hang, hang),
			code: "HANG"
		}];

		let eCwd = [0, 60, -45];
		basicCtrls.push({
			name: "crowded",
			degs: comp(0, eCwd, eCwd, eCwd, eCwd, eCwd, eCwd),
			code: "CROWDED"
		});

		let x = [0, 15, -45];
		basicCtrls.push({
			name: "pre初始姿態",
			degs: comp(0, x, x, x, x, x, x),
			code: "PRE"
		});

		basicCtrls = basicCtrls.map(ctrl => ({servos, ...ctrl}));

		let curState = "INIT";
		const execCtrl = code => {
			curState = code;
			let {degs, servos} = basicCtrls.find(ctrl => ctrl.code == code);
			console.log("Exec", curState, servos, degs);
			return fetch(`http://${window.hostIP}/servos?servos=${servos}&degs=${degs}`);
		}

		let process = "";

		createApp({
			data: () => ({
				connected: false,
				hostIP: localStorage.getItem("hostIP") ?? "",
				advancedCtrls: (()=>{
					let result = [];
					const delay = async (time) => new Promise(res => setTimeout(res, time));
					{ // 直走
						const statesOrder = ["HANG", "CROWDED", "PRE", "INIT", "READY", "A", "B", "C", "D", "E", "F", "A"];
						const delayOrder = [250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250, 250]

						result.push({
							name: "直走",
							onClick: async (e) => {
								if(process == "walkStraight") return 1;
								process = "walkStraight";
								while(process == "walkStraight"){
									console.log(curState);
									execCtrl(statesOrder[statesOrder.indexOf(curState) + 1]);
									await delay(delayOrder[statesOrder.indexOf(curState)]);
								}
								return 0;
							}
						});
					} { // 停止
						result.push({
							name: "停止",
							onClick: async (e) => {
								process = "";
							}
						})
					} {
						const stateOrder = ["READY", "N", "O", "P", "Q", "R", "READY"];

						result.push({
							name: "逆時針",
							onClick: async (e) => {
								process = "counterClockwiseRotate";

								for(let state of stateOrder){
									await delay(250);
									execCtrl(state);
								}

								process = "";
								return 0;
							}
						});
					} {
						const stateOrder = ["READY", "R", "Q", "P", "O", "N", "READY"];

						result.push({
							name: "順時針",
							onClick: async (e) => {
								process = "clockwiseRotate";

								for(let state of stateOrder){
									await delay(250);
									execCtrl(state);
								}

								process = "";
								return 0;
							}
						});
					}
					return result;
				})(),
				ctrls: basicCtrls
			}),
			methods: {
				hostIPChanged(e){
					const hostInput = e.target;
					hostInput.setCustomValidity("");

					let host = `http://${this.hostIP}/`;
					fetch(`${host}robot`)
					.then(res=>res.text())
					.then(()=>{
						window.hostIP = this.hostIP;	
						localStorage.setItem("hostIP", this.hostIP);
						this.connected = true;
					})
					.catch(()=>{ hostInput.setCustomValidity("The board is not running.") });
				},
				ctrlClicked(e){
					let {code} = e.target.dataset;
					execCtrl(code);
				}
			},
			mounted(){
				document.querySelector("#hostIP").dispatchEvent(new Event("change"));
			}
		}).mount('#app');

	</script>
	<style>
		* { box-sizing: border-box }

		#hostIP:invalid {
			background-color: red;
			color: white;
		}
	</style>
</head><body>
	<noscript><span color="white" bgcolor="red"><b>Please enable JavaScript in your browser's settings.</b></span></noscript>
	<main id="app">
		IP: <input v-model="hostIP" @change="hostIPChanged" id="hostIP" placeholder="The local IP of the board. Shown in the serial window." />

		<div id="ctrl" v-if="connected">
			<button
				v-for="ctrl in ctrls"
				@click="ctrlClicked"
				:data-code="ctrl.code"
			>{{ctrl.name}}</button>
		</div>
		<div id="advancedCtrl" v-if="connected">
			<button
				v-for="ctrl in advancedCtrls"
				:style="ctrl.style ?? ''"
				@click="ctrl.onClick"
			>{{ctrl.name}}</button>
		</div>
	</main>
</body></html>
